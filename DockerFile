# Base
FROM ubuntu:20.04

ENV DEBIAN_FRONTEND=noninteractive
RUN apt-get update && apt-get install -y \
    wget curl gnupg2 apt-transport-https ca-certificates software-properties-common unzip lsb-release

# Git
RUN apt-get install -y git

# Java (JDK para compilar apps Java)
RUN apt-get install -y openjdk-11-jdk

# Maven
RUN apt-get install -y maven

# Install PostgreSQL client 9.6 from apt.postgresql.org (client only)
RUN wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | apt-key add - \
 && echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list \
 && apt-get update \
 && apt-get install -y postgresql-client-9.6 || apt-get install -y postgresql-client

# Install .NET SDK (supports compilation of .NET Core/.NET)
RUN wget https://packages.microsoft.com/config/ubuntu/20.04/packages-microsoft-prod.deb -O /tmp/packages-microsoft-prod.deb \
 && dpkg -i /tmp/packages-microsoft-prod.deb \
 && apt-get update \
 && apt-get install -y dotnet-sdk-6.0

# Install Visual Studio Code (headless, but provides code command & extensions)
RUN wget -qO- https://packages.microsoft.com/keys/microsoft.asc | gpg --dearmor > /etc/apt/trusted.gpg.d/microsoft.gpg \
 && echo "deb [arch=amd64] https://packages.microsoft.com/repos/vscode stable main" > /etc/apt/sources.list.d/vscode.list \
 && apt-get update \
 && apt-get install -y code

# Apache server with a simple "hola mundo"
RUN apt-get install -y apache2
RUN echo '<!doctype html><html><head><meta charset="utf-8"><title>Hola Mundo</title></head><body><h1>Hola Mundo desde Docker + Apache</h1></body></html>' > /var/www/html/index.html

EXPOSE 80

# Workdir
WORKDIR /workspace

# Healthcheck
HEALTHCHECK --interval=30s --timeout=3s CMD curl -f http://localhost/ || exit 1

# Default command: start apache in foreground
CMD ["/usr/sbin/apache2ctl", "-D", "FOREGROUND"]
